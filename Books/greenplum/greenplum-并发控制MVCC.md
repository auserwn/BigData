# 并发控制MVCC

## 并发控制简介

主要是针对事务的并发。涉及到事务的ACID：原子性、一致性、隔离性、持久性。

并发产生的问题：丢失更新、不可重复读、脏读。

并发控制是在并发运行中维护事务的一致性、隔离性的一种机制。



## 并发控制不同实现方式

### 多版本并发控制MVCC（Multi-Version Concurrency Control）

MVCC(Multi-Version Concurrency Control)，即多版本并发控制，是一种数据库并发控制机制。MVCC 是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问，在多个事务同时访问数据库时保持数据的一致性和隔离性。MVCC通过在数据库中保存多个版本的数据来实现这一目标，每个事务看到的数据版本可能不同，取决于该事务启动的时间点。
在MVCC中，每个数据行都有一个创建版本号（Transaction ID）和一个销毁版本号（End Transaction ID）。当一个事务开始时，它会被分配一个唯一的事务ID。当事务对数据进行修改时，它会创建新版本的数据，并将该数据行的创建版本号设置为事务的ID。当事务提交时，它的事务ID就成为新版本数据行的销毁版本号。这样，其他事务在读取数据时，可以根据事务ID和版本号判断是否可以看到该数据。
MVCC提供了以下几个主要优势：
并发性提高： 不同事务可以并发地读取数据库，因为它们读取的是不同版本的数据。只有在事务需要写入数据时，才会涉及到锁定和冲突处理。
读写分离： 读操作不会被写操作所阻塞，允许系统在处理大量读请求时保持高性能。
事务隔离性： 每个事务看到的数据版本都是一致的，不会受到其他并发事务的影响。
高并发事务： 大量并发事务可以同时执行，而不会出现锁定和阻塞的情况。
需要注意的是，MVCC并非没有代价的。它增加了存储开销，因为每个数据行都需要存储多个版本的数据。同时，由于事务可能看到不同版本的数据，应用程序在处理并发时需要考虑一致性问题，确保读取到的数据版本是符合预期的。
不同的数据库系统实现MVCC的方式可能略有不同，但基本的概念和原理是相似的。MVCC是许多现代关系数据库系统（如PostgreSQL、Oracle、MySQL的InnoDB引擎等）中常用的并发控制机制。

MVCC的主要优势在于“读不会阻塞写，写也不会阻塞读”。相反的，接下来介绍的S2PL的系统当有写操作时必须阻塞读，因为写操作获得了独占锁。

### MVCC的变体-快照隔离机制SI（Snapshot-Isolation）

postgres使用的就是这种技术。为了实现SI，一些RDBMS（比如oracle）使用回滚段（rollback segments），当写入新的数据项时，旧的数据项会被写入回滚段，随后新项被覆盖到数据区域。Postgres更简单，新的数据项被直接插入表页，读取时，pg通过可见性检查规则来选择适当版本的数据项以响应单个事务。

### 严格的二段式锁S2PL（Strict Two-Phase Locking）

### 客观并发控制OCC（Optimistic Concurrency Control）